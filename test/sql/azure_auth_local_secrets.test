# name: test/sql/azure_auth_local_secrets.test
# description: test azure extension authentication
# group: [azure]

require azure

require parquet

require-env DUCKDB_CLI_TEST_ENV_AVAILABLE

load __TEST_DIR__/azure_auth_local_secrets.db

# Note: this test is currently not run in CI as it requires setting up quite a bit of setup.
#       for now, to run this test locally, ensure you have access to the duckdbtesting storage
#       account, then login through the cli. Then running the test with DUCKDB_CLI_TEST_ENV_AVAILABLE=1
#       should give all green!
#
# TODO: We should setup a key in CI to automatically test this. Ideally that would also involve Managed identities and
#       service principals

statement ok
CREATE PERMANENT SECRET s1 (
    TYPE AZURE,
    PROVIDER CREDENTIAL_CHAIN,
    ACCOUNT_NAME 'duckdbtesting'
)

# With the CLI credentials, private authentication should now work
query I
SELECT count(*) FROM 'azure://testing-private/l1.parquet';
----
60175

restart

# The credentials are persistent!
query I
SELECT count(*) FROM 'azure://testing-private/l*.parquet';
----
180525

