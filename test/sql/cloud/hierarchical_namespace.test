# name: test/sql/hierarchical_namespace.test
# description: test azure extension with ADLS GEN2 storage
# group: [azure]

# Require statement will ensure this test is run with this extension loaded
require azure

require-env DUCKDB_AZ_ADLS_GEN2

require-env AZURE_TENANT_ID

require-env AZURE_CLIENT_ID

require-env AZURE_CLIENT_SECRET

require-env AZURE_STORAGE_ACCOUNT

statement ok
CREATE SECRET spn (
    TYPE AZURE,
    PROVIDER SERVICE_PRINCIPAL,
    TENANT_ID '${AZURE_TENANT_ID}',
    CLIENT_ID '${AZURE_CLIENT_ID}',
    CLIENT_SECRET '${AZURE_CLIENT_SECRET}',
    ACCOUNT_NAME '${AZURE_STORAGE_ACCOUNT}'
);

query I
SELECT count(*) FROM 'abfss://hn1/key1=m*/*.csv';
----
4

query I
SELECT count(*) FROM 'abfss://hn1/key1=*/*.csv';
----
9

# Check with wildcard and depth
query I
SELECT count(*) FROM 'abfss://hn1/*/*/*.csv';
----
6

# Check with absolute path
query I
SELECT count(*) FROM 'abfss://hn1/data.csv';
----
3

# Check fully qualified name
query I
SELECT count(*) FROM 'abfss://${AZURE_STORAGE_ACCOUNT}.dfs.core.windows.net/hn1/*/*/*.csv';
----
6

# Enable http info for the explain analyze statement
statement ok
SET azure_http_stats = true;

query II
EXPLAIN ANALYZE SELECT count(*) FROM 'abfss://hn1/key1=*/*.csv';
----
analyzed_plan	<REGEX>:.*HTTP Stats\:.*in\: 1\.7 KiB.*\#HEAD\: 2.*GET\: 5.*PUT\: 0.*\#POST\: 0.*

query II
EXPLAIN ANALYZE SELECT count(*) FROM 'azure://hn1/key1=*/*.csv';
----
analyzed_plan	<REGEX>:.*HTTP Stats\:.*in\: 4\.5 KiB.*\#HEAD\: 2.*GET\: 3.*PUT\: 0.*\#POST\: 0.*
