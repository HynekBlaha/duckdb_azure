# name: test/sql/azure_spn.test
# description: test azure extension with service principal authentication
# group: [azure]

require azure

require-env TENANT_ID

require-env CLIENT_ID

require-env CLIENT_SECRET

require-env ACCOUNT_NAME

statement ok
CREATE SECRET s1 (
    TYPE AZURE,
    PROVIDER SERVICE_PRINCIPAL,
    TENANT_ID '${TENANT_ID}',
    CLIENT_ID '${CLIENT_ID}',
    CLIENT_SECRET '${CLIENT_SECRET}',
    ACCOUNT_NAME '${ACCOUNT_NAME}'
)

query I
SELECT count(*) FROM 'azure://testing-private/l.csv';
----
60175

statement ok
DROP SECRET s1

statement ok
SET azure_tenant_id = '${TENANT_ID}'

statement ok
SET azure_spn_client_id = '${CLIENT_ID}'

statement ok
SET azure_spn_client_secret = '${CLIENT_SECRET}'

statement ok
SET azure_account_name = '${ACCOUNT_NAME}'

query I
SELECT count(*) FROM 'azure://testing-private/l.csv';
----
60175

